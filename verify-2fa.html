<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Verify 2FA</title>
    <link rel="stylesheet" href="verify-2fa.css">
</head>

<body>
    <div class="container">
        <h2>Two-Factor Authentication Required</h2>
        <p>Please enter the 6-digit verification code from your authenticator app:</p>

        <div class="token-row">
            <div class="input-wrap">
                <input id="token"
                       type="password"
                       inputmode="numeric"
                       maxlength="6"
                       autocomplete="one-time-code"
                       placeholder="000000">

                <button id="toggle-visibility" aria-label="Show code">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="1.8"
                         stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
            </div>

            <div id="token-message" class="message"></div>

            <button id="verify-btn">Verify Code</button>
        </div>

        <div class="trouble-link">
            <p><a href="setup-2fa.html">Need to set up 2FA again?</a></p>
            <p><a href="index.html">‚Üê Back to Login</a></p>
        </div>
    </div>

<script>
    (function () {
        const email = localStorage.getItem("currentUser.email");

        if (!email) {
            window.location.href = "index.html";
            return;
        }

        const tokenInput = document.getElementById("token");
        const verifyBtn = document.getElementById("verify-btn");
        const toggleBtn = document.getElementById("toggle-visibility");
        const msgEl = document.getElementById("token-message");

        // === MESSAGE SYSTEM ===
        function showMessage(msg, type = "error") {
            msgEl.textContent = msg;
            msgEl.className = "message " + (type === "success" ? "success" : "error");
        }

        function clearMessage() {
            msgEl.textContent = "";
            msgEl.className = "message";
        }

        // === INPUT FILTERING ===
        tokenInput.addEventListener("input", () => {
            tokenInput.value = tokenInput.value.replace(/\D/g, "").slice(0, 6);
            clearMessage();

            if (tokenInput.value.length === 6) {
                verify2FA();
            }
        });

        // === VISIBILITY TOGGLE ===
        toggleBtn.addEventListener("click", () => {
            const isHidden = tokenInput.type === "password";
            tokenInput.type = isHidden ? "text" : "password";
            toggleBtn.setAttribute("aria-pressed", String(!isHidden));
        });

        // === BUTTON CLICK ===
        verifyBtn.addEventListener("click", verify2FA);

        function verify2FA() {
            const token = tokenInput.value.trim();

            if (token.length !== 6) {
                showMessage("Enter a 6-digit code.");
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.textContent = "Verifying...";

            fetch("http://localhost:5500/api/verify-2fa", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, token })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.verified) {
                    showMessage("Invalid code.");
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = "Verify Code";
                    return;
                }

                showMessage("2FA Verified!", "success");

                setTimeout(() => {
                    if (email === "admin@admin.com" || email === "mrakaazwar@gmail.com") {
                        window.location.href = "admin.html";
                    } else {
                        window.location.href = "home.html";
                    }
                }, 700);
            })
            .catch(() => {
                showMessage("Network error.");
                verifyBtn.disabled = false;
                verifyBtn.textContent = "Verify Code";
            });
        }

        // Autofocus
        tokenInput.focus();
    })();
</script>
</body>
</html>
