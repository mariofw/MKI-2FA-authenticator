<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Verify 2FA</title>
    <link rel="stylesheet" href="verify-2fa.css">
</head>

<body>
    <div class="container">
        <h2>Two-Factor Authentication Required</h2>
        <p>Please open Google Authenticator and enter the 6-digit verification code:</p>

        <input id="token" placeholder="000000" maxlength="6" autocomplete="one-time-code" inputmode="numeric">
        <br>
        <button id="verify-btn">Verify Code</button>
        
        <div class="trouble-link">
            <p><a href="setup-2fa.html">Need to set up 2FA again?</a></p>
            <p><a href="index.html">← Back to Login</a></p>
        </div>
    </div>

<script>
    const email = localStorage.getItem("currentUser.email");

    if (!email) {
        alert("No user session found. Please login again.");
        window.location.href = "index.html";
    }

    const tokenInput = document.getElementById("token");
    const verifyBtn = document.getElementById("verify-btn");

    // Auto focus
    tokenInput.focus();

    // Auto verify when 6 digits typed
    tokenInput.addEventListener("input", () => {
        if (tokenInput.value.trim().length === 6) {
            verify2FA();
        }
    });

    // Button click verify
    verifyBtn.addEventListener("click", verify2FA);

    function verify2FA() {
        const token = tokenInput.value.trim();

        if (!/^\d{6}$/.test(token)) {
            alert("Please enter a valid 6-digit code.");
            return;
        }

        verifyBtn.disabled = true;
        verifyBtn.textContent = "Verifying...";

        fetch("http://localhost:5500/api/verify-2fa", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, token })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.verified) {
                alert("❌ Invalid code. Try again.");
                verifyBtn.disabled = false;
                verifyBtn.textContent = "Verify Code";
                return;
            }

            alert("✅ 2FA Verified Successfully!");

            // Redirect based on user
            if (email === "admin@admin.com" || email === "mrakaazwar@gmail.com") {
                window.location.href = "admin.html";
            } else {
                window.location.href = "home.html";
            }
        })
        .catch(err => {
            console.error("Verification error:", err);
            alert("Verification failed. Check server.");
            verifyBtn.disabled = false;
            verifyBtn.textContent = "Verify Code";
        });
    }
</script>
</body>
</html>
