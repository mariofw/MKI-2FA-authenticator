<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Setup 2FA</title>
    <link rel="stylesheet" href="setup-2fa.css">
</head>

<body>
    <div class="container">
        <h2>Set up Two-Factor Authentication</h2>
        <p>Scan the QR code with Google Authenticator or Authy:</p>

        <div id="qrcode">
            <!-- QR will be injected here -->
        </div>

        <p>Enter the 6-digit code from your authenticator app:</p>

        <div class="token-row">
            <div class="input-wrap">
                <input id="token" 
                       type="password" 
                       inputmode="numeric"
                       maxlength="6"
                       autocomplete="one-time-code"
                       placeholder="000000">

                <button id="toggle-visibility" aria-label="Show code">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="1.8"
                         stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
            </div>

            <div id="token-message" class="message"></div>

            <button id="verify-btn">Verify & Enable 2FA</button>
        </div>

        <div class="trouble-link">
            <a href="index.html">← Back to Login</a>
        </div>
    </div>

<script>
    (function () {
        const email = localStorage.getItem("currentUser.email");
        const qrcodeEl = document.getElementById('qrcode');
        const tokenInput = document.getElementById('token');
        const verifyBtn = document.getElementById('verify-btn');
        const toggleBtn = document.getElementById('toggle-visibility');
        const msgEl = document.getElementById('token-message');

        function showInlineError(msg) {
            qrcodeEl.innerHTML = `<div style="color:#b00020;padding:12px;text-align:center;">${msg}</div>`;
        }

        function showMessage(msg, type='error') {
            msgEl.textContent = msg;
            msgEl.className = 'message ' + (type === 'success' ? 'success' : 'error');
        }

        function clearMessage() {
            msgEl.textContent = '';
            msgEl.className = 'message';
        }

        if (!email) {
            showInlineError("No user session found. Returning to login…");
            setTimeout(() => window.location.href = "index.html", 900);
            return;
        }

        const QR_ENDPOINT = `http://localhost:5500/api/generate-2fa?email=${encodeURIComponent(email)}`;
        const VERIFY_ENDPOINT = `http://localhost:5500/api/verify-2fa`;

        async function loadQRCode() {
            try {
                qrcodeEl.innerHTML = "Loading QR…";
                const res = await fetch(QR_ENDPOINT);

                if (!res.ok) return showInlineError("Failed to load QR (server error).");

                const data = await res.json();
                if (!data.qrCodeDataURL) return showInlineError("Invalid server response.");

                qrcodeEl.innerHTML = `<img src="${data.qrCodeDataURL}" width="200" height="200">`;

            } catch {
                showInlineError("QR load failed. Backend offline?");
            }
        }

        loadQRCode();

        tokenInput.addEventListener('input', () => {
            tokenInput.value = tokenInput.value.replace(/\D/g, '').slice(0, 6);
            clearMessage();
        });

        toggleBtn.addEventListener('click', () => {
            const isHidden = tokenInput.type === 'password';
            tokenInput.type = isHidden ? 'text' : 'password';
            toggleBtn.setAttribute("aria-pressed", String(!isHidden));
        });

        verifyBtn.addEventListener('click', async () => {
            const token = tokenInput.value.trim();

            if (token.length !== 6) {
                showMessage("Enter a 6-digit code");
                return;
            }
            
            verifyBtn.disabled = true;
            verifyBtn.textContent = "Verifying...";

            try {
                const res = await fetch(VERIFY_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, token })
                });

                const data = await res.json();

                if (!data.verified) {
                    showMessage("Invalid code.");
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = "Verify & Enable 2FA";
                    return;
                }

                showMessage("2FA Enabled!", "success");
                localStorage.setItem(`2fa.${email}.enabled`, "true");

                setTimeout(() => {
                    if (email === "admin@admin.com" || email === "mrakaazwar@gmail.com") {
                        window.location.href = "admin.html";
                    } else {
                        window.location.href = "home.html";
                    }
                }, 700);

            } catch {
                showMessage("Network error.");
                verifyBtn.disabled = false;
                verifyBtn.textContent = "Verify & Enable 2FA";
            }
        });

    })();
</script>

</body>
</html>
